---
title: "FileScriptingアプリ"
date: 2018-02-22 04:55:13
---

### 粗筋

Android上で、ファイル関連の雑務を片付けるスクリプト環境が欲しくなる。

具体的にはmicroSDを128GBに乗り換えた事で、以前ScanSnapでスキャンしたpdfファイルを幾つか突っ込める余裕が出てきた。
この中身は無圧縮のjpegが埋め込まれているだけなので、単純にjpegのヘッダをseekしてmemcpyするだけでjpegファイルは取り出せる。
で、これが50ページ単位くらいのpdfに分かれているのを、一つのフォルダに連番jpegとして突っ込んでzipで固めたりしたい。

こういう類のファイル関連の雑務を軽くこなすスクリプト環境をAndroid上にも欲しくなってきた。

数日前にそういう話も書いた。

[blog: Android上の日常的な雑務をやるスクリプト環境が欲しい](https://karino2.github.io/2018/02/17/159.html)

という事で作ろう。  
まず名前をつける。名前はFileScriptingとした。

### コンセプト

キーボードはつなげる前提で考えている。
PowerShell ISVみたいな環境があれば良い。



![](https://i.imgur.com/5fxpFT7.png)

イメージ的にはこういう感じで。

まず言語はとりあえずBeanShellというので行ってみようかな、と思っている。
luaでもいいかな、と思っていて、どっちにするかはまだ未定。

コマンドラインの所ではcdとかlsとかするし、パイプも作りたい。
ここはスクリプト言語とは別の簡易言語にするしか無いかな、と思っている。
cdするとグローバル変数のCWDとかが変更されて、上の窓のスクリプトと真ん中のコマンドラインの環境は共有されている。

イコールの左辺に変数をドル付きで書けて、これは上のスクリプトのドルなしグローバル変数として扱われる。
イコールの右辺を全て実行した最終的結果が左辺に入る。
ストリーミングも全部arrayに変換して突っ込む。

出来たらpowershellのwhenに相当する物とか作りたいが、まぁ無理にとは言わない。
適当にlsとかの結果を変数に突っ込んで、細かい事は上のスクリプトでやる。
ただlsはワイルドカードくらいは頑張りたい。catも出来たら文字列のリストにする位はやりたいなぁ。

スクリプトは今の所SQLiteに突っ込んで、ListViewから適当に選んで開く、でタブで複数開いて、このスクリプトを複数組み合わせて手動でevalしていく事で目的を達成していく。


もともとの目的からバイナリを扱う必要があるので、下のJavaをそのまま触れるのがいいかな、と思う。
権限的には今の所ネットワークはなしでいいかなぁ。
EXTERNAL_STORAGEのwritableとreadableくらいでなんとかならないかなぁ。


### 実装順序

1. 単発コマンドでcdとlsくらいだけをサポートしたやる気無いコマンドラインで、上のスクリプトウィンドウと下のコンソール出力をとりあえず動かす
2. コマンドラインをまともなパーサーコンビネータで書き直し、イコールをサポート
3. 過去スクリプトのListViewと複数タブをサポート
4. パイプをサポート
5. スクリプトのexportをサポート

3くらいまで終われば使い物にはなる気がする。
1さえ終われば3まではイケる気がするので、使う所までは行くんじゃないか。

5まで終われば一般にも公開していいかなぁ。

最終的にはimportとかも必要だろうけれど、とりあえずバックアップさえ出来ればimportは必要になったらやればいいか、とは思っている。

### ソースコード置き場

ということで作り始めた。 [https://github.com/karino2/TextBluetoothShareMash](https://github.com/karino2/TextBluetoothShareMash)

### lsとかprintはオリジナルのBeanShellとは変えたい

BeanShellはコマンドが.bshファイルでいろいろ定義されてて、それが必要に応じて自動でロードされるという仕組みとなっているっぽい。
だからAndroidならassets下に置いてそれをロードするようにした方が良いのだろうな、
という気はするのだが、ローダー的な物を差し替えないと行けなくて、これが意外とめんどいので、最初は.bshファイルの中身をraw stringにコピペして起動時にevalしている。

で、dirは全部テキストをprintする感じのコマンドになっている。
だが、PowerShell民としてはこれはFileのIterableであって欲しい。
まぁ実用上はFileのArrayListでも良い。

で、そうすると出力の所も書き換える必要があって、formatterが要る、という話になると思う。
まずはハードコードでいいかなぁ、という気がするが。

そうすると、そもそもprintの実装もその辺いろいろやってしまっているが、
スクリプトレイヤでやるんじゃなくて、Kotlin側でやる方が筋が良いよな。
そうしよう。

ついでにAndroidだとdirじゃなくてlsだよな、という気もするので、コマンド名も変えよう。

パイプはIterable的なのにするかListにしてしまうか、ちょっと悩む。まぁパイプまで行ってから考えよう。

そう考えるとcatも`Iterable<String>`だよな。
そういう感じにしておこう。
