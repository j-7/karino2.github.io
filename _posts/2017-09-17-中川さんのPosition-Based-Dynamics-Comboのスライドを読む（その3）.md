---
title: "中川さんのPosition-Based-Dynamics-Comboのスライドを読む（その3）"
date: 2017-09-17 13:00:03
---

中川さんのスライドを読んでいく、第三弾。

## Air Meshes for Robust Collision Handling

これはデモが無いと良くわからんなぁ。
とソースコードを眺めていたら、binというフォルダに中身がある。
これ実行すればいいんじゃない？

実行出来たヽ(´ー｀)ノ

ただ早すぎて良くわからん。

AirMeshという物を生成し、そのAIr Meshが特定の制約を維持し続けるような拘束条件を用いる、という事のよう。  
Air Meshというのはデモのこの黒い線で結ばれている三角形たちの事のようだ。

頂点からこれらの三角形はドロネー三角形分割というので機械的に生成出来るらしい。

これらのAir Meshの向きが変わらない、とはどういう制約になるのだろうか？

スライド51のunilateralというのは、外積の符号が変わらない、という事だろう。
だから右ネジの法則の向きが同じまま、という事で、生成された頂点が、そのなす辺をまたがない、という感じの制約になるのだろう。  
体積も良くはわからんが、たぶん裏返らない、という事だろうなぁ。

これらの制約を適用すると何が起こるのだろうか？

ソースコードを見ていると、距離の拘束は別に入れているので、四角形が四角形のままなのはそちらのせいだろう。  
Air Meshの制約が入るのは、メッシュの頂点が辺をまたごうとした時なので、この四角の箱がくっついて突き抜けない、というのを保証している気がする。

なるほど、衝突判定みたいなのを実装する時に、それを覆うメッシュの向きが保存される、という拘束条件でそれが表現出来る、という事か。

### メッシュの品質とか最適化とか

あんまり向きが一気に変わると拘束条件を適用した状態が前の向きを再現するかは怪しいのだから、一度にboundされる拘束条件は近場では一つな事が望ましかろう。
そう考えると一気に2つ超えそうな、潰れた三角形とかがあんまり多いのは望ましくない事が考えられる。

潰れる三角形はまさに接触という状態を表す時に必要になるから全部潰れたのをなくす訳じゃないだろうが、定期的に三角形分割をやり直す方が良い、というのは納得出来る。
三角形分割は頂点同士の並びなどは変えないのだから、再分割の前に保存されていた向きは、再分割後も向きを保存し続ける限り保存されるはず。

スライド55の真ん中の絵は三角形になってないように見えるので何を意図しているのか分からない。
偶然赤と黒の点が直線になった時は直線とみなすの？それは無いような気がするが…

数式は真面目には追わないが、そんな難しい話でも無いので理解は出来る。

### 応用例

スライド60の応用例を見ると、布同士を重ねたいのか。
こういう時に突き抜けないように出来るってのが嬉しい訳ね。
確かにこのAir Meshという拘束条件を使えばそれは保証出来る気がする。

## XPBD Position-Based Simulation of Compliant Constrained Dynamics

Air Meshgaあんまり長くなかったので同じエントリで次のも見てしまおう。

Xはextendedらしい。まぁビートXでもガンダムXでも、なんかXってつけたくなる事ってあるよな。

そしてヤング率が出て来る。懐かしいな。

---

スライド72〜74で式がいろいろ出てきて、アルファがゼロだとPBDと同じ、とか言うが、全然ついていけないので、まずPBDの式を見直す。

PBDの式はスライド14にあった。

![](https://i.imgur.com/SQmp050.jpg)

これが一次のテイラー展開の式で、これが満たされるように $$ \Delta p $$を決めましょう、という話だった。  
sと言っていたのは、この$$ \Delta p $$をどう各pに分配するか、という重みの係数みたいなものだった。

今更だが軽くここを導出しなおしてみよう。


### PBDのsの導出

C(p)をコストと考えれば、gradを元にpをずらしてこれを最小化するのは、通常のgradient descentになる。
向きとしてはもっともC(p)を下げる向きはgradと同じ向きで、向きはgradの反対、となるので、 $$ \Delta p $$は以下のようにおける。

![](https://i.imgur.com/NbbkXyl.jpg)

ここでkは正の定数。次に、この $$ \Delta p_i $$をすべてのiについて足した結果が、ちょうど一次のテイラー展開の式をゼロとするように、このkを定める。
この時点ではkはpの添字iに依存した物か。

で、ずれ具合は質量の逆数に応じて配分されるようにしたい。
そこでまず、質量の逆数をkの外に出して足し合わせる事を考える。
質量の部分で配分の割合は決定出来ているので、残りの比例定数は添字に依存しない。
これをsと置く。つまり、こうだ。

![](https://i.imgur.com/fafi4en.jpg)

ここでsは添字によらない、正の定数。これがスライド14の(9)式だな。

あとはこのsを求める。各点に対してこの差分を足し合わせた結果が、ちょうど一次のテイラー展開の式をゼロとするようにsを決めれば良い。

![](https://i.imgur.com/v38I75Z.jpg)

![](https://i.imgur.com/L0Kxsi7.jpg)

これはスライド14の(8)式だな。なるほど。こうやって求まるものなのか。

点は $$ p_j $$ 個だけあって、それぞれの点におけるgradは違うが、いわゆる最急降下するのだから、C(p)の減らし具合に関しては絶対値だけ考えれば十分。

### XPBDのラグランジュ乗数ってなんなのさ？

突然スライド72で登場するラグランジュ乗数だが、sに沿った物らしいので、sを求めてみた今ならわかるんじゃないか。

まずラグランジュ乗数と言っているのだから、何かしらのラグランジアンがある訳だよな。

何かの最小化問題を、制約条件付きで解いているはずだ。
それを考えると、制約条件はC(p)=0のような気がする。

それでは最小化したいのは？
普通に考えたら調整にかかるエネルギーだよな。

う、これは剛性体を曲げる時のエネルギーを計算する必要がある。
引っ張るなら単純にバネと同じになるんだが、曲げるのはちょっとかったるいんだよなぁ。

ちょっとガチ変分計算になるので、ゆとりの自分には辛い。
そこでその式はとりあえず $$ E(\Delta p) $$と置く事にしよう。

するとラグランジアンはたぶんこうか？

![](https://i.imgur.com/qnncoAs.jpg)

この場合、ラムダは経済学のお話で言う所のシャドウプライスに相当する訳だよな。
Cがちょっとゼロからずれた時のエネルギーコストの比例定数、になるんだっけ。
覚えてない…


気分的にはデルタpで微分してイコール0で置くと、

![](https://i.imgur.com/6FXgfu1.jpg)

これにEの具体的な形を代入すると、スライド72の式(18)のようになる、という事かな。
自信は無いが。

### xの更新アルゴリズム(スライド72）

合っているかはいまいち自信が無いが、あっているとして話を進めよう。

ではこのスライド72のアルゴリズム、4.1から4.4は何をやっているのか？

おそらく一回のイテレーションでだいたい必要なエネルギー最小の元でCがゼロになるようにpを動かす事は出来るのだろう。

だがPBDの時も、複数の拘束条件がある時には、イテレーションして全部の拘束条件が小さくなるような値に調整出来ると期待する、という物だった。
そこは同じだろう。

ではラグランジュ乗数を更新するとはどういう事か？
